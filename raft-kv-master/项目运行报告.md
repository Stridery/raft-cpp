# 环境安装

## 依赖库

apt-get install libglib2.0-dev
sudo apt-get install libmsgpack-dev 
sudo apt-get install libhiredis-dev 
sudo apt-get update

sudo apt-get install libboost-all-dev
sudo apt-get install libgtest-dev 

## install go:

主要是参考了一下的博客：

https://blog.csdn.net/goodattainment/article/details/130812111

wget -c https://dl.google.com/go/go1.14.2.linux-amd64.tar.gz -O - | sudo tar -xz -C /usr/local

export PATH=$PATH:/usr/local/go/bin
source ~/.profile

go install github.com/mattn/goreman@latest
## 
手动下载包安装，如果clone不了，只能科学上网了
mkdir -p $GOPATH/src/github.com/mattn
cd $GOPATH/src/github.com/mattn
git clone https://github.com/mattn/goreman.git
cd $GOPATH/src/github.com/mattn/goreman

go env -w GOPROXY=https://goproxy.cn,direct

go install



# 项目bug寻找

主要是用过观察日志的方式找到的：

### 第一个bug

在三个节点的时候我发现有一个节点总是莫名其妙挂掉，看日志似乎是与磁盘上的持久化的日志id不一致：

```cpp
if (state.commit < raft_log_->committed_ || state.commit > raft_log_->last_index()) 
```

定位到了这句话，这句话的意思是当前的commitid与日志中的commitid先作比较，但是一般按照raft的理论来说，快照只会保留之前的，也就是commitid一定会比当前的小，所以这个需要修改为：

```cpp
if (state.commit > raft_log_->last_index()) 
```



## 第二个bug

这个找的时候比较简单，就是有一个位置是nullptr了，但是却访问了里面的值：

```cpp
	ProgressPtr progress = get_progress(node);
    if (progress) {
      LOG_INFO("%lu restored progress of %lu [%s]", id_, node, progress->string().c_str());
    } else {
      LOG_ERROR("Progress for %lu not found", node);
    }
    // LOG_INFO("%lu restored progress of %lu [%s]", id_, node, get_progress(id_)->string().c_str());
```



# 验证

集群数量为5：

```apl
# Use goreman to run `go get github.com/mattn/goreman`
node1: ./raft-kv/raft-kv --id 1 --cluster=127.0.0.1:12379,127.0.0.1:22379,127.0.0.1:32379,127.0.0.1:42379,127.0.0.1:52379 --port 63791
node2: ./raft-kv/raft-kv --id 2 --cluster=127.0.0.1:12379,127.0.0.1:22379,127.0.0.1:32379,127.0.0.1:42379,127.0.0.1:52379 --port 63792
node3: ./raft-kv/raft-kv --id 3 --cluster=127.0.0.1:12379,127.0.0.1:22379,127.0.0.1:32379,127.0.0.1:42379,127.0.0.1:52379 --port 63793
node4: ./raft-kv/raft-kv --id 4 --cluster=127.0.0.1:12379,127.0.0.1:22379,127.0.0.1:32379,127.0.0.1:42379,127.0.0.1:52379 --port 63794
node5: ./raft-kv/raft-kv --id 5 --cluster=127.0.0.1:12379,127.0.0.1:22379,127.0.0.1:32379,127.0.0.1:42379,127.0.0.1:52379 --port 63795

```

验证指令顺序：

```
goreman start       // 启动5个集群
redis-cli -p 63791  // redis链接一个数据库
set mykey myvalue   // 添加值

goreman run stop node2 
redis-cli -p 63792  // 此时连接不上node2了
set mykey new-value   // 添加值
goreman run start node2 
redis-cli -p 63792  // 此时连接上node2了
get mykey           // 此时值也变为了new-value
```

也就是说在其中一个节点宕机了，再恢复之后是能实现同步功能的。....